{% extends 'base.html' %}
{% block title %}Dashboard de Acciones - Bolsa de Santiago{% endblock %}
{% block head %}
{{ super() }}
<!-- Estilos de DataTables (sin cambios) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<!-- Recursos para el Dashboard de Widgets -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<style>
    .summary-card { transition: transform 0.2s ease-in-out; }
    .summary-card:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Fila de Resumen Principal (sin cambios) -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3 mb-md-0">
            <div class="card shadow-sm h-100"><div class="card-body text-center">
                <h5 class="card-title"><i class="fas fa-robot me-2"></i>Estado del Bot</h5>
                <div id="statusMessage" class="alert alert-info small py-2"><i class="fas fa-info-circle me-1"></i>Inicializando...</div>
                <div id="lastUpdate" class="text-muted small"><i class="fas fa-clock me-1"></i>Última act: --</div>
            </div></div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100"><div class="card-body text-center">
                <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Resumen de Portafolio</h5>
                <div class="row">
                    <div class="col-4"><h6>Pagado</h6><p id="totalPaid" class="h5 mb-0">--</p></div>
                    <div class="col-4"><h6>Valor Actual</h6><p id="totalCurrentValue" class="h5 mb-0">--</p></div>
                    <div class="col-4"><h6>Ganancia/Pérdida</h6><p id="totalGainLoss" class="h5 mb-0">--</p></div>
                </div>
            </div></div>
        </div>
    </div>
    <!-- Barra de Herramientas Principal -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <label for="autoUpdateSelect" class="form-label mb-0 text-nowrap">Auto-Update:</label>
                <select id="autoUpdateSelect" class="form-select form-select-sm" style="width: auto;">
                    <option value="off">Desactivado</option><option value="1-3">1-3 min</option>
                    <option value="3-5">3-5 min</option><option value="5-10">5-10 min</option>
                </select>
                <span id="countdownTimer" class="text-muted small ms-2"></span>
            </div>
            <div class="d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-info dropdown-toggle" type="button" id="addWidgetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-plus-circle me-2"></i>Añadir Widget
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="addWidgetDropdown" id="widget-list">
                        <li><a class="dropdown-item" href="#" data-widget-id="portfolio">Mi Portafolio</a></li>
                        <li><a class="dropdown-item" href="#" data-widget-id="market-data">Datos del Mercado</a></li>
                        <li><a class="dropdown-item" href="#" data-widget-id="closing-data">Cierre Bursátil Anterior</a></li>
                        <li><a class="dropdown-item" href="#" data-widget-id="controls">Configuración y Acciones</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-widget-id="drainers"><i class="fas fa-search-dollar me-2"></i>Análisis de Drainers</a></li>
                    </ul>
                </div>
                <button type="button" id="refreshBtn" class="btn btn-success"><i class="fas fa-sync-alt me-2"></i>Actualizar Ahora</button>
            </div>
        </div>
    </div>
    <!-- Contenedor de GridStack -->
    <div class="grid-stack"></div>
</div>
{% include '_modals.html' %}
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="loading-content">
        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5 id="loadingMessage" class="text-light">Cargando...</h5>
    </div>
</div>

<!-- Plantillas para Widgets -->
<template id="portfolioTemplate">
    <div class="grid-stack-item-content">
        <div class="widget-header">
            <h5 class="widget-title"><i class="fas fa-briefcase me-2"></i>Mi Portafolio</h5>
            <div class="widget-controls">
                <button class="btn btn-sm btn-outline-secondary" onclick="uiManager.openModal('portfolioColumnConfigModal')"><i class="fas fa-sliders-h"></i></button>
                <button type="button" class="btn btn-sm btn-danger remove-widget-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="widget-body">
            <div id="portfolio-summary" class="row text-center mb-3">
                <div class="col-4">
                    <h6>Pagado</h6>
                    <p id="totalPaid" class="h5 mb-0">--</p>
                </div>
                <div class="col-4">
                    <h6>Valor Actual</h6>
                    <p id="totalCurrentValue" class="h5 mb-0">--</p>
                </div>
                <div class="col-4">
                    <h6>Ganancia/Pérdida</h6>
                    <p id="totalGainLoss" class="h5 mb-0">--</p>
                </div>
            </div>
            <div class="table-responsive">
                <table id="portfolioTable" class="table table-sm table-hover">
                    <thead></thead>
                    <tbody>
                        <tr><td colspan="100%" class="text-center p-4">Cargando portafolio...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-group-divider fw-bold">
                            <td id="footer-label" colspan="3">Totales:</td>
                            <td id="footerTotalPaid"></td>
                            <td></td>
                            <td id="footerTotalCurrentValue"></td>
                            <td id="footerTotalGainLoss"></td>
                            <td id="footerTotalGainLossPercent"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</template>

<template id="newsTemplate">
    <div class="grid-stack-item-content">
        <div class="widget-header">
            <h5 class="widget-title"><i class="fas fa-newspaper me-2"></i>Últimas Noticias</h4>
            <div class="widget-controls">
                <button id="newsRefreshBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync-alt"></i></button>
                <button type="button" class="btn btn-sm btn-danger remove-widget-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="widget-body" id="news-widget-body">
            <div id="news-loading" class="text-center p-4">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="ms-2">Cargando noticias...</span>
            </div>
            <ul id="news-list" class="list-group list-group-flush d-none">
                <!-- Las noticias se insertarán aquí -->
            </ul>
        </div>
    </div>
</template>

<template id="controlsTemplate">
    <div class="grid-stack-item-content">
        <div class="widget-header">
            <h5><i class="fas fa-cogs me-2"></i>Configuración y Acciones</h5>
            <div class="widget-controls">
                <button type="button" class="btn btn-sm btn-danger remove-widget-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="widget-body">
            <form id="stockFilterForm" class="mb-3 p-2 border rounded bg-body-tertiary small">
                <label class="form-label fw-bold">Filtrar Datos del Mercado:</label>
                <div class="row g-2">
                    <div class="col-6"><input type="text" class="form-control form-control-sm stock-code" placeholder="COPEC"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm stock-code" placeholder="SQM-B"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm stock-code" placeholder="CMPC"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm stock-code" placeholder="FALABELLA"></div>
                </div>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="allStocksCheck" checked>
                    <label class="form-check-label" for="allStocksCheck">Todas</label>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button type="button" id="clearBtn" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-primary">Aplicar</button>
                </div>
            </form>
            <form id="portfolioForm" class="mb-3 p-2 border rounded bg-body-tertiary small">
                <label class="form-label fw-bold">Añadir Activo:</label>
                <div class="row g-2 align-items-end">
                    <div class="col-12"><input type="text" id="portfolioSymbol" class="form-control form-control-sm" placeholder="Símbolo" required></div>
                    <div class="col-6"><input type="number" step="any" id="portfolioQuantity" class="form-control form-control-sm" placeholder="Cantidad" required></div>
                    <div class="col-6"><input type="number" step="any" id="portfolioPrice" class="form-control form-control-sm" placeholder="Precio Compra" required></div>
                    <div class="col-12"><button type="submit" class="btn btn-sm btn-info w-100">Añadir a Portafolio</button></div>
                </div>
            </form>
        </div>
    </div>
</template>

<template id="alertsTemplate">
    <div class="grid-stack-item-content">
        <div class="widget-header">
            <h5><i class="fas fa-bell me-2"></i>Alertas de Precio</h5>
            <div class="widget-controls">
                <button type="button" class="btn btn-sm btn-danger remove-widget-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="widget-body">
            <form id="alertForm" class="p-2 border rounded bg-body-tertiary small mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-12"><input type="text" id="alertSymbol" class="form-control form-control-sm" placeholder="Símbolo" required></div>
                    <div class="col-6"><input type="number" step="0.01" id="alertPrice" class="form-control form-control-sm" placeholder="Precio Obj." required></div>
                    <div class="col-6">
                        <select id="alertCondition" class="form-select form-select-sm">
                            <option value="above">Suba &gt;=</option>
                            <option value="below">Baje &lt;=</option>
                        </select>
                    </div>
                    <div class="col-12"><button type="submit" class="btn btn-sm btn-warning w-100">Crear Alerta</button></div>
                </div>
            </form>
            <div id="alert-list-container" style="max-height: 200px; overflow-y: auto;">
                <div id="alert-loading" class="text-center p-2">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </div>
                <ul id="alert-list" class="list-group list-group-flush d-none"></ul>
            </div>
        </div>
    </div>
</template>

<template id="drainersTemplate">
    <div class="grid-stack-item-content">
        <div class="widget-header">
            <h5><i class="fas fa-search-dollar me-2"></i>Análisis de Adelantamientos</h5>
            <div class="widget-controls">
                <button type="button" class="btn btn-sm btn-danger remove-widget-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="widget-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <p class="text-muted small mb-0">Detecta eventos anómalos.</p>
                <button id="runAnalysisBtn" class="btn btn-primary"><i class="fas fa-play-circle me-2"></i>Ejecutar Análisis</button>
            </div>
            <div id="drainerAlert" class="alert d-none" role="alert"></div>
            <div class="table-responsive">
                <table id="drainersTable" class="table table-striped table-hover w-100"></table>
            </div>
        </div>
    </div>
</template>

{% endblock %}
{% block scripts %}
{{ super() }}
<!-- LIBRERÍAS DE TERCEROS -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.js"></script>

<!-- MÓDULOS DE LA APLICACIÓN -->
<script src="{{ url_for('static', filename='uiManager.js') }}"></script>
<script src="{{ url_for('static', filename='portfolioManager.js') }}"></script>
<script src="{{ url_for('static', filename='closingManager.js') }}"></script>
<script src="{{ url_for('static', filename='newsManager.js') }}"></script>
<script src="{{ url_for('static', filename='alertManager.js') }}"></script>
<script src="{{ url_for('static', filename='drainerManager.js') }}"></script>
<script src="{{ url_for('static', filename='controlsManager.js') }}"></script>
<script src="{{ url_for('static', filename='autoUpdater.js') }}"></script>
<script src="{{ url_for('static', filename='dashboardLayout.js') }}"></script>
<script src="{{ url_for('static', filename='eventHandlers.js') }}"></script>

<!-- SCRIPT PRINCIPAL (AL FINAL) -->
<script src="{{ url_for('static', filename='app.js') }}"></script>
{% endblock %}