<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.0/dist/dom-to-image-more.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">Bolsa App</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/historico.html">Hist√≥rico</a></li>
                    <li class="nav-item"><a class="nav-link" href="/analisis.html">An√°lisis</a></li>
                    <li class="nav-item"><a class="nav-link" href="/arquitectura.html">Arquitectura</a></li>
                </ul>
                <button id="themeToggle" class="btn btn-outline-light ms-lg-3" type="button" aria-label="Toggle theme"></button>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <h1 class="mb-4">‚öôÔ∏è Arquitectura de la Aplicaci√≥n</h1>
        <ul class="nav nav-tabs" id="diagramTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-arch" data-bs-toggle="tab" data-bs-target="#pane-arch" type="button" role="tab" aria-controls="pane-arch" aria-selected="true">Arquitectura</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-flow" data-bs-toggle="tab" data-bs-target="#pane-flow" type="button" role="tab" aria-controls="pane-flow" aria-selected="false">Flujo</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-event" data-bs-toggle="tab" data-bs-target="#pane-event" type="button" role="tab" aria-controls="pane-event" aria-selected="false">Eventos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-error" data-bs-toggle="tab" data-bs-target="#pane-error" type="button" role="tab" aria-controls="pane-error" aria-selected="false">Dependencias</button>
            </li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="pane-arch" role="tabpanel" aria-labelledby="tab-arch">
                <h2 class="h5">Diagrama de Arquitectura</h2>
                <div id="archDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#d1e7dd','primaryBorderColor':'#93c5b3','lineColor':'#198754','fontFamily':'Inter'}} }%%
            graph LR
                ServiceAgent["üß† ServiceAgent"] --> ScrapingAgent["üåê ScrapingAgent"]
                ScrapingAgent --> HARParserAgent["üîÑ HARParserAgent"]
                HARParserAgent --> SessionAgent
                ScrapingAgent --> HARFile[HAR File]
                HARParserAgent --> Data[Datos JSON]
                Data --> ServiceAgent
                ServiceAgent --> RealTimeSyncAgent["üåê RealTimeSyncAgent"]
                RealTimeSyncAgent --> Frontend[Web Frontend]
                click Data noop "Datos transformados en JSON"
                click ServiceAgent noop "Orquesta la ejecuci√≥n peri√≥dica y guarda resultados"
                click ScrapingAgent noop "Captura los datos desde el sitio web"
                click HARParserAgent noop "Extrae las respuestas JSON del HAR"
                click SessionAgent noop "Mantiene viva la autenticaci√≥n"
                click RealTimeSyncAgent noop "Env√≠a datos al frontend en tiempo real"
                click Frontend noop "Interfaz web para los usuarios"
                </div>
                <div class="text-end my-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('archDiagram')">Exportar imagen</button>
                </div>
                <div class="ms-2">
                    <p class="mb-1"><strong>ServiceAgent:</strong> orquesta la ejecuci√≥n peri√≥dica del scraping y almacena los resultados.</p>
                    <p class="mb-1"><strong>ScrapingAgent:</strong> captura los datos en crudo desde la p√°gina web en tiempo real.</p>
                    <p class="mb-1"><strong>HARParserAgent:</strong> procesa el archivo HAR generado y extrae la respuesta JSON relevante.</p>
                    <p class="mb-1"><strong>SessionAgent:</strong> conserva el estado de autenticaci√≥n y lo renueva cuando expira.</p>
                    <p class="mb-1"><strong>RealTimeSyncAgent:</strong> env√≠a por WebSocket las actualizaciones al <em>frontend</em>.</p>
                    <p class="mb-1"><strong>Frontend:</strong> interfaz de usuario que presenta los datos procesados.</p>
                </div>
            </div>
            <div class="tab-pane fade" id="pane-flow" role="tabpanel" aria-labelledby="tab-flow">
                <h2 class="h5">Flujo de Recolecci√≥n de Datos</h2>
                <div id="flowDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#e2eafc','primaryBorderColor':'#a7bff6','lineColor':'#0d6efd','fontFamily':'Inter'}} }%%
            flowchart TD
                Start([Iniciar recolecci√≥n]) --> Login{¬øLogin correcto?}
                Login -- S√≠ --> Scrape["üåê Ejecuci√≥n del scraping"]
                Login -- No --> LoginError[Credenciales inv√°lidas]
                LoginError --> EndAuth(Fin error)
                Scrape --> Response{¬øRespuesta v√°lida?}
                Response -- S√≠ --> Validate["üîÑ Validar datos"]
                Validate --> Cache[Almacenar en cach√©]
                Cache --> Notify["üß† Guardar y notificar"]
                Notify --> EndSuccess(Fin √©xito)
                Response -- No --> Retry{¬øReintentar?}
                Retry -- S√≠ --> Scrape
                Retry -- No --> NetError[Error de red]
                NetError --> EndNet(Fin error)
                click Login noop "Verifica si la sesi√≥n sigue activa o es necesario autenticarse"
                click Scrape noop "Obtiene las p√°ginas y genera el HAR"
                click Validate noop "Comprueba que los datos tengan formato esperado"
                click Cache noop "Guarda una copia temporal para reutilizar"
                click Notify noop "Almacena en BD y avisa al frontend"
                </div>
                <div class="text-end my-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('flowDiagram')">Exportar imagen</button>
                </div>
                <div class="ms-2">
                    <p class="mb-1">El flujo contempla validaciones de credenciales, posibles fallos de red y la repetici√≥n del scraping en caso de error. Tras validar los datos, se almacenan en cach√© y se publican.</p>
                </div>
            </div>
            <div class="tab-pane fade" id="pane-event" role="tabpanel" aria-labelledby="tab-event">
                <h2 class="h5">Eventos en la Interfaz</h2>
                <div id="eventDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#f8d7da','primaryBorderColor':'#f1aeb5','lineColor':'#dc3545','fontFamily':'Inter'}} }%%
            flowchart TD
                subgraph "Carga inicial"
                    A["Usuario abre localhost:5000"] --> B["Carga HTML principal (app.js)"]
                    B --> C[/api/session-time]
                    C --> D[/api/stocks?code=...]
                    D --> E["Renderizar tabla"]
                    E --> F["Mostrar timestamp"]
                end
                subgraph "Bot√≥n Filtrar"
                    G["Ingresar c√≥digos"] --> H["Click en Filtrar"]
                    H --> I["GET /api/stocks?code=CENCOSUD&..."]
                    I --> J["Actualizar tabla"]
                    J --> K["Mensaje de √©xito"]
                end
                subgraph "Bot√≥n Actualizar"
                    L["Click en Actualizar"] --> M["POST /api/update"]
                    M --> N["Activar ScrapingAgent"]
                    N --> O["Abrir navegador (Playwright)"]
                    O --> P["Generar network_summary y acciones-precios-plus"]
                    P --> Q["Filtrar resultados v√°lidos"]
                    Q --> R["Persistir JSON"]
                    R --> S["Actualizar tabla (si corresponde)"]
                end
                </div>
                <div class="text-end my-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('eventDiagram')">Exportar imagen</button>
                </div>
                <div class="ms-2">
                    <p class="mb-1">Cada subgrafo describe el flujo que sigue la aplicaci√≥n ante una acci√≥n del usuario.</p>
                </div>
            </div>
            <div class="tab-pane fade" id="pane-error" role="tabpanel" aria-labelledby="tab-error">
                <h2 class="h5">Mapa de Dependencias y Errores</h2>
                <div id="errorDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#d1dfe4','primaryBorderColor':'#a0b3bc','lineColor':'#0dcaf0','fontFamily':'Inter'}} }%%
            graph LR
                Front[Frontend] --> API[/API Flask/]
                API --> Service[ServiceAgent]
                Service --> Scrape[ScrapingAgent]
                Scrape --> Parse[HARParserAgent]
                Service --> DB[(Base de datos)]
                Service --> Sync[RealTimeSyncAgent]
                Sync --> Front
                Scrape -.-> Captcha((Captcha/Timeout))
                Parse -.-> HarErr((HAR inv√°lido))
                DB -.-> DBErr((Fallo BD))
                Sync -.-> WsErr((Error WebSocket))
                </div>
                <div class="text-end my-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('errorDiagram')">Exportar imagen</button>
                </div>
                <div class="ms-2">
                    <p class="mb-1">El mapa destaca los puntos donde podr√≠an surgir errores comunes para facilitar la depuraci√≥n.</p>
                </div>
            </div>
        </div>
        <h2 class="h5 mt-4">Estructura de Archivos</h2>
        <pre class="bg-body-tertiary p-2 rounded small">
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îú‚îÄ‚îÄ extensions.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îî‚îÄ‚îÄ tests/
        </pre>
        <table class="table table-sm">
            <thead>
                <tr><th>Archivo/Carpeta</th><th>Descripci√≥n</th></tr>
            </thead>
            <tbody>
                <tr><td><code>src/main.py</code></td><td>Punto de entrada de la aplicaci√≥n Flask.</td></tr>
                <tr><td><code>src/config.py</code></td><td>Define rutas y variables globales.</td></tr>
                <tr><td><code>src/extensions.py</code></td><td>Inicializa la base de datos y Socket.IO.</td></tr>
                <tr><td><code>src/models/</code></td><td>Modelos SQLAlchemy para usuarios y precios.</td></tr>
                <tr><td><code>src/routes/api.py</code></td><td>Endpoints REST para datos de acciones.</td></tr>
                <tr><td><code>src/routes/user.py</code></td><td>Operaciones CRUD de usuarios.</td></tr>
                <tr><td><code>src/scripts/bolsa_service.py</code></td><td>Orquestador del scraping y almacenamiento.</td></tr>
                <tr><td><code>src/scripts/bolsa_santiago_bot.py</code></td><td>Bot de Playwright que captura datos.</td></tr>
                <tr><td><code>src/scripts/har_analyzer.py</code></td><td>Extrae informaci√≥n √∫til del archivo HAR.</td></tr>
                <tr><td><code>src/static/</code></td><td>HTML, CSS y JavaScript del frontend.</td></tr>
                <tr><td><code>tests/</code></td><td>Conjunto de pruebas automatizadas con pytest.</td></tr>
            </tbody>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/theme.js"></script>
    <script>
        function noop() {}
        function exportDiagram(id) {
            const node = document.getElementById(id);
            if (!node) return;
            domtoimage.toPng(node)
                .then(dataUrl => {
                    const link = document.createElement('a');
                    link.download = id + '.png';
                    link.href = dataUrl;
                    link.click();
                })
                .catch(err => console.error('export failed', err));
        }
    </script>
</body>
</html>
