<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.0/dist/dom-to-image-more.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">Bolsa App</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/historico.html">Histórico</a></li>
                    <li class="nav-item"><a class="nav-link" href="/analisis.html">Análisis</a></li>
                    <li class="nav-item"><a class="nav-link" href="/arquitectura.html">Arquitectura</a></li>
                </ul>
                <button id="themeToggle" class="btn btn-outline-light ms-lg-3" type="button" aria-label="Toggle theme"></button>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <h1 class="mb-4">⚙️ Arquitectura de la Aplicación</h1>
        <h2 class="h5">Diagrama de Arquitectura</h2>
        <div id="archDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#d1e7dd','primaryBorderColor':'#93c5b3','lineColor':'#198754','fontFamily':'Inter'}} }%%
            graph LR
                ServiceAgent["🧠 ServiceAgent"] --> ScrapingAgent["🌐 ScrapingAgent"]
                ScrapingAgent --> HARParserAgent["🔄 HARParserAgent"]
                HARParserAgent --> SessionAgent
                ScrapingAgent --> HARFile[HAR File]
                HARParserAgent --> Data[Datos JSON]
                Data --> ServiceAgent
                ServiceAgent --> RealTimeSyncAgent["🌐 RealTimeSyncAgent"]
                RealTimeSyncAgent --> Frontend[Web Frontend]
                click Data noop "Datos transformados en JSON"
                click ServiceAgent noop "Orquesta la ejecución periódica y guarda resultados"
                click ScrapingAgent noop "Captura los datos desde el sitio web"
                click HARParserAgent noop "Extrae las respuestas JSON del HAR"
                click SessionAgent noop "Mantiene viva la autenticación"
                click RealTimeSyncAgent noop "Envía datos al frontend en tiempo real"
                click Frontend noop "Interfaz web para los usuarios"
        </div>
        <div class="text-end my-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('archDiagram')">Exportar imagen</button>
        </div>
        <div class="ms-2">
            <p class="mb-1"><strong>ServiceAgent:</strong> orquesta la ejecución periódica del scraping y almacena los resultados.</p>
            <p class="mb-1"><strong>ScrapingAgent:</strong> captura los datos en crudo desde la página web en tiempo real.</p>
            <p class="mb-1"><strong>HARParserAgent:</strong> procesa el archivo HAR generado y extrae la respuesta JSON relevante.</p>
            <p class="mb-1"><strong>SessionAgent:</strong> conserva el estado de autenticación y lo renueva cuando expira.</p>
            <p class="mb-1"><strong>RealTimeSyncAgent:</strong> envía por WebSocket las actualizaciones al <em>frontend</em>.</p>
            <p class="mb-1"><strong>Frontend:</strong> interfaz de usuario que presenta los datos procesados.</p>
        </div>
        <h2 class="h5 mt-4">Flujo de Recolección de Datos</h2>
        <div id="flowDiagram" class="mermaid">
            %%{init: {'theme':'base','themeVariables':{'primaryColor':'#e2eafc','primaryBorderColor':'#a7bff6','lineColor':'#0d6efd','fontFamily':'Inter'}} }%%
            flowchart TD
                Start([Iniciar recolección]) --> Login{¿Login correcto?}
                Login -- Sí --> Scrape["🌐 Ejecución del scraping"]
                Login -- No --> LoginError[Credenciales inválidas]
                LoginError --> EndAuth(Fin error)
                Scrape --> Response{¿Respuesta válida?}
                Response -- Sí --> Validate["🔄 Validar datos"]
                Validate --> Cache[Almacenar en caché]
                Cache --> Notify["🧠 Guardar y notificar"]
                Notify --> EndSuccess(Fin éxito)
                Response -- No --> Retry{¿Reintentar?}
                Retry -- Sí --> Scrape
                Retry -- No --> NetError[Error de red]
                NetError --> EndNet(Fin error)
                click Login noop "Verifica si la sesión sigue activa o es necesario autenticarse"
                click Scrape noop "Obtiene las páginas y genera el HAR"
                click Validate noop "Comprueba que los datos tengan formato esperado"
                click Cache noop "Guarda una copia temporal para reutilizar"
                click Notify noop "Almacena en BD y avisa al frontend"
        </div>
        <div class="text-end my-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="exportDiagram('flowDiagram')">Exportar imagen</button>
        </div>
        <div class="ms-2">
            <p class="mb-1">El flujo contempla validaciones de credenciales, posibles fallos de red y la repetición del scraping en caso de error. Tras validar los datos, se almacenan en caché y se publican.</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/theme.js"></script>
    <script>
        function noop() {}
        function exportDiagram(id) {
            const node = document.getElementById(id);
            if (!node) return;
            domtoimage.toPng(node)
                .then(dataUrl => {
                    const link = document.createElement('a');
                    link.download = id + '.png';
                    link.href = dataUrl;
                    link.click();
                })
                .catch(err => console.error('export failed', err));
        }
    </script>
</body>
</html>
